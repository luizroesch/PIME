library(pime)
library(tidyverse)
library(tictoc)
library(phyloseq)
restroom
sep=pime.split.by.variable(restroom, "Environment")
prev=pime.prevalence(sep)
prev
#best2=pime.best.prevalence(prev, "Environment")
#best2
######NEW FUNCTION BEST.PREVALENCE WITH IMPORTANCE ISTEAD OF BETA DIVERSITY
best.prevalenceII<- function (prev.list, variable) {
  randon=list()
  imp=list()
  gs <- as(object = sample_data(prev.list[[1]]), Class = "data.frame")
  Variable = as.factor(gs[, variable])
  pb <- progress::progress_bar$new(total = length(prev.list), clear=F)
  pb$tick(0)
  for (i in prev.list){
    if ((phyloseq::taxa_are_rows(i)==TRUE)==TRUE){
      train=t(otu_table(i))
    } else {
      train=otu_table(i)}
    pb$tick()
    Sys.sleep(1 / 100)
    response = Variable
    set.seed(2124)
    training.set <- data.frame(response, train)# Combine them into 1 data frame
    train.model = ranger::ranger(response ~ ., data = training.set, importance = "permutation")
    randon[[length(randon)+1]]=train.model$prediction.error
    Importance=train.model$variable.importance %>% sort(decreasing = T)
    ii=data.frame(names(Importance), Importance) %>% filter(Importance > mean(Importance))
    k=data.frame(rownames(tax_table(i)),tax_table(i)) %>% filter(.[,1]%in%ii[,1])
    names(k)[1]<-c("SequenceID")
    imp[[length(imp)+1]]=k
  }
  #names tables from Lista as the names of the tables inside list.core
  names(randon) <- paste("Prevalence", names(prev.list))
  names(imp) <- paste("Prevalence", names(prev.list))
  #gets only the first line, all columns of every table inside perm
  #results1 <- do.call(rbind, lapply(perm,`[`,1,))
  Interval= paste(as.numeric(names(prev.list)), "%", sep = "")
  OOB <- sapply(randon, cbind)
  colnames(imp)
  Nseqs=sapply(prev.list, function(z) sum(phyloseq::sample_sums(z)))
  OTUs=sapply(prev.list, phyloseq::ntaxa)
  OOB.err=as.data.frame(cbind(OOB,Interval,OTUs,Nseqs))
  print(OOB.err)
  return(list("OOB error"=OOB.err, "Importance"=imp))
}
set.seed(42)
tic()
best2=pime.best.prevalence.II(prev, "Environment")
toc()
best2$`OOB error`
best2$Importance$`Prevalence 55`
prev.55=best2$Importance$`Prevalence 55`

#############VALIDATION
library(tidyverse)
library(pime)
set.seed(2124)

library(ranger)
gs <- as(object = sample_data(prev$`55`), Class = "data.frame")
Variable = as.factor(gs[, "Environment"])
response = Variable
train=t(otu_table(prev$`55`))
# Combine them into 1 data frame
training.set <- data.frame(response, train)
set.seed(2124)
train.model = ranger::ranger(response ~ ., data = training.set, importance = "permutation")
train.model
Importance=train.model$variable.importance
otu.imp=data.frame(names(Importance), Importance) %>% filter(Importance > mean(Importance))
k=data.frame(rownames(tax_table(prev$`55`)),tax_table(prev$`55`)) %>% filter(.[,1]%in%otu.imp[,1])
names(k)[1]<-c("SequenceID")
#k=data.frame(k,tax[,-1])
##
dim(prev.55)
dim(k)
setdiff(k, prev.55)


names(tax2)[1]<-c("SequenceID")
names(tax2)[1]
